#![warn(unused_crate_dependencies, unreachable_pub)]
#![deny(unused_must_use, rust_2018_idioms)]

use alloy_primitives::{hex, keccak256, Address, FixedBytes};
use byteorder::{BigEndian, ByteOrder, LittleEndian};
use console::Term;
use fs4::FileExt;
use ocl::{Buffer, Context, Device, MemFlags, Platform, ProQue, Program, Queue};
use rand::{thread_rng, Rng};
use rayon::prelude::*;
use separator::Separatable;
use std::error::Error;
use std::fmt::Write as _;
use std::fs::{File, OpenOptions};
use std::io::prelude::*;
use std::time::{SystemTime, UNIX_EPOCH};
use terminal_size::{terminal_size, Height};
use tiny_keccak::{Hasher, Keccak};

mod reward;
pub use reward::Reward;

// workset size (tweak this!)
const WORK_SIZE: u32 = 0x4000000; // max. 0x15400000 to abs. max 0xffffffff

const WORK_FACTOR: u128 = (WORK_SIZE as u128) / 1_000_000;
const CONTROL_CHARACTER: u8 = 0xff;
const MAX_INCREMENTER: u64 = 0xffffffffffff;

static KERNEL_SRC: &str = include_str!("./kernels/keccak256.cl");

/// Requires three hex-encoded arguments: the address of the contract that will
/// be calling CREATE2, the address of the caller of said contract *(assuming
/// the contract calling CREATE2 has frontrunning protection in place - if not
/// applicable to your use-case you can set it to the null address)*, and the
/// keccak-256 hash of the bytecode that is provided by the contract calling
/// CREATE2 that will be used to initialize the new contract. An additional set
/// of three optional values may be provided: a device to target for OpenCL GPU
/// search, a threshold for leading zeroes to search for, and a threshold for
/// total zeroes to search for.
pub struct Config {
    pub factory_address: [u8; 20],
    pub calling_address: [u8; 20],
    pub init_code_hash: [u8; 32],
    pub gpu_device: u8,
    pub leading_zeroes_threshold: u8,
    pub total_zeroes_threshold: u8,
}

/// Validate the provided arguments and construct the Config struct.
impl Config {
    pub fn new(mut args: std::env::Args) -> Result<Self, &'static str> {
        // get args, skipping first arg (program name)
        args.next();

        let factory_address_string = args.next().unwrap_or(String::from("0x762fcf49c5ef21510755191bbed6aa2a702f0348"));
        let calling_address_string = args.next().unwrap_or(String::from("0x762fcf49c5ef21510755191bbed6aa2a702f0348"));
        let init_code_hash_string = args.next().unwrap_or(String::from("0x6101a0604052346100bf5761001b61001561013b565b916102b8565b604051614ab49081611dd18239608051818181610616015281816109d701528181611ad501528181611b4701528181611d8c01528181611e200152818161207b0152612f24015260a05181613759015260c05181613810015260e05181613723015261010051816137a8015261012051816137ce0152610140518161160e0152610160518161163a0152610180518181816108fb015281816145a501526148910152f35b5f80fd5b634e487b7160e01b5f52604160045260245ffd5b601f909101601f19168101906001600160401b038211908210176100fa57604052565b6100c3565b6040519061010e6040836100d7565b565b51906001600160a01b03821682036100bf57565b6001600160401b0381116100fa5760051b60200190565b61690590813803806040519361015182866100d7565b84398201906060838303126100bf5761016983610110565b61017560208501610110565b604085015190946001600160401b0382116100bf57019280601f850112156100bf5783516101a281610124565b946101b060405196876100d7565b81865260208087019260051b8201019283116100bf57602001905b8282106101da57505050929190565b602080916101e784610110565b8152019101906101cb565b604051906102016040836100d7565b60098252565b61020f6101f2565b906862616d626f6f31333960b81b6020830152565b604051906102336040836100d7565b60018252603160f81b6020830152565b61024b6101f2565b906842616d626f6f31333960b81b6020830152565b6040519061026f6040836100d7565b60048252634231333960e01b6020830152565b634e487b7160e01b5f52601160045260245ffd5b908160209103126100bf576102aa90610110565b90565b6040513d5f823e3d90fd5b6102e8906004936102c7610207565b6102cf610224565b6102d7610243565b916102e0610260565b93339561055f565b6102f1816109c1565b601a80546001600160a01b0319166001600160a01b0383161790556103176105dc601655565b61032261012c601755565b61032c6032601355565b61033862278d00601455565b61034142601255565b6001600160a01b0381165f9081526020805260409020610369905b805460ff19166001179055565b305f908152602080526040902061037f9061035c565b61039964010000000064ff00000000196011541617601155565b6103ab600160ff19601c541617601c55565b6103bf6a497421a5557c070c000000601b55565b734752ba5dbc23f44d87826276bf6fd6b1c372ad246101808190526020906103ee905b6001600160a01b031690565b60405163c45a015560e01b815293849182905afa91821561051c575f9261053e575b506101805160049060209061042f906103e2906001600160a01b031681565b6040516315ab88c960e31b815292839182905afa90811561051c575f9360209261048d928691610521575b506040516364e329cb60e11b81523060048201526001600160a01b03909116602482015294859283919082906044820190565b03926001600160a01b03165af191821561051c5761010e926104d3915f916104ed575b50601880546001600160a01b0319166001600160a01b0392909216919091179055565b6018546104e8906001600160a01b03166109fa565b610a48565b61050f915060203d602011610515575b61050781836100d7565b810190610296565b5f6104b0565b503d6104fd565b6102ad565b6105389150843d86116105155761050781836100d7565b5f61045a565b61055891925060203d6020116105155761050781836100d7565b905f610410565b9096956105719095939594929461095d565b6001600160a01b03166080528051906001600160401b0382116100fa576105a28261059d6004546107ad565b6107e5565b602090601f83116001146106dc5791806105d6926105de95945f926106d1575b50508160011b915f199060031b1c19161790565b600455610884565b6105e781610b30565b610140526105f482610c22565b61016052602081519101206101005260208151910120610120524660c05261061a610d14565b60a0523060e0525f5b825181101561066e578061066861035c61064f61064260019588610799565b516001600160a01b031690565b6001600160a01b03165f908152600c6020526040902090565b01610623565b50905061067c61ea60600f55565b6106866014601055565b61069560ff1960115416601155565b6106a961010060115461ff00191617601155565b6106bf623c000062ff0000196011541617601155565b61010e63ff0000001960115416601155565b015190505f806105c2565b60045f52601f19831691907f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b925f5b81811061074b57509160019391856105de97969410610733575b505050811b01600455610884565b01515f1960f88460031b161c191690555f8080610725565b9293602060018192878601518155019501930161070b565b634e487b7160e01b5f52603260045260245ffd5b8051156107845760200190565b610763565b8051600110156107845760400190565b80518210156107845760209160051b010190565b90600182811c921680156107db575b60208310146107c757565b634e487b7160e01b5f52602260045260245ffd5b91607f16916107bc565b601f81116107f1575050565b60045f5260205f20906020601f840160051c8301931061082b575b601f0160051c01905b818110610820575050565b5f8155600101610815565b909150819061080c565b601f821161084257505050565b5f5260205f20906020601f840160051c8301931061087a575b601f0160051c01905b81811061086f575050565b5f8155600101610864565b909150819061085b565b80519091906001600160401b0381116100fa576108ad816108a66005546107ad565b6005610835565b602092601f82116001146108e1576108dc929382915f926106d15750508160011b915f199060031b1c19161790565b600555565b60055f52601f198216937f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db0915f5b868110610945575083600195961061092d575b505050811b01600555565b01515f1960f88460031b161c191690555f8080610922565b9192602060018192868501518155019401920161090f565b6001600160a01b031680156109ae575f80546001600160a01b03198116831782556001600160a01b0316907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09080a3565b631e4fbdf760e01b5f525f60045260245ffd5b6001600160a01b038116156109e7576c0b3548624a5b3cd344c000000061010e91610d73565b63ec442f0560e01b5f525f60045260245ffd5b60018060a01b0316805f52602160205260405f20600160ff19825416179055604051600181527fcf6988e4ab219d22e184919b0127588d212fb5379d51b3f958911e45c7b4e83a60203392a3565b610a50610e79565b5f546001600160a01b03163015610b1d578015610b0a57305f8181526002602090815260408083206001600160a01b03861684528252808320839055519182525f5160206168c55f395f51905f5291a3610aa8610e79565b610ab18161095d565b308015610b1d576001600160a01b038216918215610b0a575f8281526002602090815260408083206001600160a01b039094168352929052205f1990556040515f1981525f5160206168c55f395f51905f5290602090a3565b634a1406b160e11b5f525f60045260245ffd5b63e602df0560e01b5f525f60045260245ffd5b908151602081105f14610b485750906102aa90610f01565b6001600160401b0381116100fa57610b6c81610b656006546107ad565b6006610835565b602092601f8211600114610ba357610b9b929382915f926106d15750508160011b915f199060031b1c19161790565b60065560ff90565b60065f52601f198216937ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f915f5b868110610c0a5750836001959610610bf2575b505050811b0160065560ff90565b01515f1960f88460031b161c191690555f8080610be4565b91926020600181928685015181550194019201610bd1565b908151602081105f14610c3a5750906102aa90610f01565b6001600160401b0381116100fa57610c5e81610c576007546107ad565b6007610835565b602092601f8211600114610c9557610c8d929382915f926106d15750508160011b915f199060031b1c19161790565b60075560ff90565b60075f52601f198216937fa66cc928b5edb82af9bd49922954155ab7b0942694bea4ce44661d9a8736c688915f5b868110610cfc5750836001959610610ce4575b505050811b0160075560ff90565b01515f1960f88460031b161c191690555f8080610cd6565b91926020600181928685015181550194019201610cc3565b61010051610120516040519060208201927f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f8452604083015260608201524660808201523060a082015260a08152610d6d60c0826100d7565b51902090565b908015610e6e575f8052602080527f29ab76e7ca72530a8284597fb76b039d796325740b21528d71ade454c6f2dbe95460ff168015610e4e575b8015610e3f575b610e355790610de561010e92610dca835f611153565b60115460201c60ff1680610dfb575b610dec575b825f61138a565b905f611030565b610df68184611238565b610dde565b505f80526021602052610e307f97ea4a93fb5e400340102ffa4fa5d31ef170c1e583d2cb268c876db385f80bb05b5460ff1690565b610dd9565b61010e915f611030565b5060ff601c5460081c16610db4565b506001600160a01b0382165f90815260208052604090205460ff16610dad565b5061010e905f610f6c565b5f546001600160a01b03163303610e8c57565b63118cdaa760e01b5f523360045260245ffd5b6001600160a01b0316908115610b1d576001600160a01b038116928315610b0a5780610ef45f5160206168c55f395f51905f5293855f52600260205260405f209060018060a01b03165f5260205260405f2090565b55604051908152602090a3565b601f815111610f2c576020815191015160208210610f1d571790565b5f198260200360031b1b161790565b604460209160405192839163305a27a960e01b83528160048401528051918291826024860152018484015e5f828201840152601f01601f19168101030190fd5b91905f906001600160a01b038416801590811561101657610f97610f9285600354611226565b600355565b6001600160a01b0383169081611000575b6040518581525f5160206168855f395f51905f5290602090a3610fd0575b61010e929361145c565b6003546001600160d01b0390818111610fea575050610fc6565b630e58ae9360e11b845260045260245250604490fd5b6001600160a01b0384165f526001602052610fa8565b6001600160a01b0386165f90815260016020529350610f97565b9291906001600160a01b03841680159081156110ee57611055610f9285600354611226565b6001600160a01b03831690816110cc576110728560035403600355565b6040518581525f5160206168855f395f51905f5290602090a36110995761010e929361145c565b600354936001600160d01b038086116110b457509350610fc6565b630e58ae9360e11b5f52600486905260245260445b5ffd5b6001600160a01b0384165f908152600160205260409020858154019055611072565b6001600160a01b0386165f9081526001602052604090205484811061112f576001600160a01b0387165f908152600160205260409020908590039055611055565b63391434e360e21b5f526001600160a01b038716600452602452604484905260645ffd5b60ff60115460181c1680156111b7575b8015611196575b611172575050565b6389ca956560e01b5f9081526001600160a01b039182166004529116602452604490fd5b506001600160a01b0382165f9081526022602052604090205460ff1661116a565b506001600160a01b0381165f9081526022602052604090205460ff16611163565b60405190919060a081016001600160401b038111828210176100fa57604052608060048294805484526001810154602085015260028101546040850152600381015460608501520154910152565b9190820180921161123357565b610282565b6001600160a01b0381165f908152601d602052604090209091905480156113505761127361126e825f52601f60205260405f2090565b6111d8565b906112846112808361155e565b1590565b61133157506060810161129b61128082518661157d565b6112e75750608001518091116112c757506001600160a01b03165f908152601e60205260409020429055565b6339f1ab3360e11b5f526001600160a01b0390911660045260245260445ffd5b836113126110c9926113098360018060a01b03165f52601e60205260405f2090565b54905190611226565b62f3369760e71b5f526001600160a01b03909116600452602452604490565b631d2e5cc360e21b5f526001600160a01b03841660045260245260445ffd5b6373509bdf60e01b5f526001600160a01b03831660045260245260445ffd5b5f1981019190821161123357565b9190820391821161123357565b908260175415611456576113bd91601954601b5411158061144a575b80611432575b80611422575b6113f1575b8361177e565b90816113c857505090565b916113ec826102aa946113e56113e083601954611226565b601955565b3090611030565b61137d565b611405610100601c5461ff00191617601c55565b61140d6115c1565b61141d601c5461ff001916601c55565b6113b7565b5060ff601c5460081c16156113b2565b506018546001600160a01b03858116911614156113ac565b5060ff601c54166113a6565b50505090565b9091906001600160a01b031680156114c3575b61010e926001600160a01b03169081156114ab575b5f90815260096020526040808220549282529020546001600160a01b039081169116611963565b6114bc6114b784611834565b611865565b5050611484565b6114cc82611834565b9265ffffffffffff431161154657600b548061151057506115066114f661010e955f5b6001611d74565b65ffffffffffff4316600b611c9e565b905050925061146f565b93845f1981011161123357600b5f525f5160206168a55f395f51905f529094015461010e94611506916114f6919060301c6114ef565b6306dfcc6560e41b5f5260306004524360245260445ffd5b60208101514210159081611570575090565b9050604042910151101590565b6001600160a01b03165f818152601e602052604090205415919082156115a257505090565b9091505f52601e60205260405f20549081018091116112335742101590565b601b548015611768578060011c9081810390811161123357476115e2611a5f565b916115ff306115f085610777565b6001600160a01b039091169052565b6101805160049060209061161d906103e2906001600160a01b031681565b6040516315ab88c960e31b815292839182905afa801561051c5761164c915f91611749575b506115f085610789565b61165b6113e08260195461137d565b610180516116759082906001600160a01b03165b30610e9f565b6101805161168d906103e2906001600160a01b031681565b92833b156100bf576116bc935f928360405180978195829463791ac94760e01b84524291309160048601611a8b565b03925af191821561051c576116d79261172f575b504761137d565b81151580611726575b6116e8575050565b81611714827ff57bc8a758e34a73fa02c39d5c4c83f6025dbf3df95899ecc7c023cf4212762294611b0f565b604080519182526020820192909252a1565b508015156116e0565b8061173d5f611743936100d7565b80611a81565b5f6116d0565b611762915060203d6020116105155761050781836100d7565b5f611642565b50565b8181029291811591840414171561123357565b6001600160a01b03165f90815260208052604090205460ff168015611814575b8015611805575b6117ff576001600160a01b03165f9081526021602052604090206117c890610e29565b806117f4575b6117d757505f90565b6117ec6102aa916117e6611be9565b9061176b565b612710900490565b5060175415156117ce565b50505f90565b50601c5460081c60ff166117a5565b506001600160a01b0381165f90815260208052604090205460ff1661179e565b6001600160d01b03811161184e576001600160d01b031690565b6306dfcc6560e41b5f5260d060045260245260445ffd5b65ffffffffffff431161154657600b548061188f57506114f661188b915f5b6002611d74565b9091565b805f1981011161123357600b5f525f5160206168a55f395f51905f52015461188b916114f69160301c611884565b65ffffffffffff4311611546578054806118f157506118e161188b925f6002611d74565b9065ffffffffffff431690611c9e565b805f19810111611233575f82815260209020015f19015461188b926118e19160301c611884565b65ffffffffffff43116115465780548061193c57506118e161188b925f6001611d74565b805f19810111611233575f82815260209020015f19015461188b926118e19160301c6114ef565b6001600160a01b03808316939291908116908185141580611a56575b61198b575b5050505050565b816119fc575b5050826119a0575b8080611984565b6001600160a01b03165f908152600a602052604090205f5160206168e55f395f51905f52916119d9916119d39091611834565b90611918565b604080516001600160d01b039384168152919092166020820152a25f8080611999565b6001600160a01b03165f908152600a602052604090205f5160206168e55f395f51905f5290611a3490611a2e86611834565b906118bd565b604080516001600160d01b039384168152919092166020820152a25f80611991565b5083151561197f565b60405160609190611a7083826100d7565b6002815291601f1901366020840137565b5f9103126100bf57565b91909493929460a083019083525f602084015260a060408401528151809152602060c084019201905f5b818110611ad5575050506001600160a01b03909416606082015260800152565b82516001600160a01b0316845260209384019390920191600101611ab5565b908160609103126100bf578051916040602083015192015190565b6019549080820391821161123357611bab92611b2c606093601955565b61018051611b449083906001600160a01b031661166f565b61018051611b5c906103e2906001600160a01b031681565b601a5460405163f305d71960e01b815230600482015260248101949094525f6044850181905260648501526001600160a01b031660848401524260a484015291938492918391829060c4820190565b03925af1801561051c57611bbc5750565b611bdd9060603d606011611be2575b611bd581836100d7565b810190611af4565b505050565b503d611bcb565b6012544203428111611233576014548015611c3757611c0c91046013549061176b565b601754908181019081811161123357601654918211611c2a57505090565b8103915081116112335790565b634e487b7160e01b5f52601260045260245ffd5b908154680100000000000000008110156100fa5760018101808455811015610784575f9283526020928390208251929093015160301b65ffffffffffff191665ffffffffffff9290921691909117910155565b80549293928015611d4a57611cb5611cc09161136f565b825f5260205f200190565b8054603081901c9365ffffffffffff91821692918116808411611d3b57879303611d075750611d0392509065ffffffffffff82549181199060301b169116179055565b9190565b915050611d0391611d27611d196100ff565b65ffffffffffff9093168352565b6001600160d01b0386166020830152611c4b565b632520601d60e01b5f5260045ffd5b5090611d6f91611d5b611d196100ff565b6001600160d01b0385166020830152611c4b565b5f9190565b91909180600114611db657600214611d9a57634e487b7160e01b5f52605160045260245ffd5b6001600160d01b03908116918116919091039081116112335790565b506001600160d01b0391821690821601908111611233579056fe6080604052600436101561001a575b3615610018575f80fd5b005b5f3560e01c806302e9fe31146105595780630396cb601461055457806306fdde031461054f578063095ea7b31461054a5780630bb345cf146105455780630e316ab7146105405780631150e21e1461053b578063146f7d1d146105365780631694505e1461053157806318160ddd1461052c5780631e53dbe914610527578063205c28781461052257806320bec12c1461051d57806323b872dd146105185780632530d5911461051357806325e102a91461050e5780632753e2bd1461050957806329ce1ec514610504578063313ce567146104ff57806334b562fb146104fa5780633a46b1a8146104f55780633c70e0da146104f05780633f4ba83a146104eb578063432452c6146104e657806349bd5a5e146104e15780634bf5d7e9146104dc5780635525dcfb146104d7578063587cde1e146104d25780635b16ebb7146104cd5780635c19a95c146104c85780635c975abb146104c357806364c0a2f8146104be578063655a4e9c146104b95780636d82838b146104b45780636fcfff45146104af57806370a08231146104aa578063715018a6146104a5578063736c0d5b146104a0578063796d43711461049b5780637adbf973146104965780637dc0d1d0146104915780637ecebe001461048c5780637f2465da146104875780638456cb591461048257806384b0196e1461047d5780638da5cb5b146104785780638e539e8c1461047357806391ddadf41461046e57806395d89b41146104695780639ab24eb0146104645780639b02184f1461045f5780639ec9f5cd1461045a578063a6d1a8fb14610455578063a71f848414610450578063a9059cbb1461044b578063a9a2340914610446578063b0bb6d8114610441578063b0d691fe1461043c578063b918e5f914610437578063bb9fe6bf14610432578063bbfebfe01461042d578063bcd8f77a14610428578063bda844c114610423578063bf6a68ab1461041e578063c23a5cea14610419578063c399ec8814610414578063c3cda5201461040f578063c8454a191461040a578063c8816e0914610405578063cba0e99614610400578063ce409d84146103fb578063d0e30db0146103f6578063da21bcbc146103f1578063dd16f847146103ec578063dd62ed3e146103e7578063eb12d61e146103e2578063ec0d4982146103dd578063ede31502146103d8578063f1127ed8146103d3578063f2fde38b146103ce578063f465c77e146103c9578063f77e8e2d146103c4578063fab52689146103bf5763fbac39510361000e5761269e565b61265e565b61252c565b6124c4565b6123ff565b612353565b612336565b61228e565b61221d565b6121be565b612175565b6120d7565b61206d565b612050565b612011565b611ff4565b611f8e565b611eab565b611df5565b611d64565b611d47565b611c16565b611bc0565b611b9c565b611b2c565b611b04565b611ac0565b611aa3565b611a3a565b611a10565b6119aa565b61198d565b611927565b611907565b6118b6565b611811565b6117e6565b6116ed565b6116c6565b6115f6565b611551565b61152e565b6114f3565b6114cb565b611452565b611435565b6113f5565b61139e565b611362565b6112fa565b6112bf565b6112a2565b611280565b61125b565b611235565b6111f5565b6111b2565b61118b565b6110fb565b6110d3565b6110b0565b611044565b610f8a565b610ef1565b610e4a565b610d15565b610ca3565b610c68565b610bfd565b610bdb565b610b03565b610a6a565b6109ab565b610947565b61092a565b6108e6565b610898565b61087b565b61080d565b6107eb565b6107b6565b6106cb565b6105ef565b61056c565b8015150361056857565b5f80fd5b34610568576020366003190112610568576004356105898161055e565b610591612c9b565b151560115464ff000000008260201b169064ff000000001916176011556040519081527ff7037b9866379dd7eb64dcd967ffaf919604727a9625c68ede8b97269feadc0e60203392a2005b6024359063ffffffff8216820361056857565b5f60203660031901126105685760043563ffffffff8116810361056857610614612c9b565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031690813b156105685763ffffffff60245f926040519485938492621cb65b60e51b845216600483015234905af1801561068457610678575080f35b61001891505f90610d9a565b6126f2565b5f91031261056857565b805180835260209291819084018484015e5f828201840152601f01601f1916010190565b9060206106c8928181520190610693565b90565b34610568575f366003190112610568576040515f6004546106eb816126fd565b80845290600181169081156107815750600114610723575b61071f8361071381850382610d9a565b604051918291826106b7565b0390f35b60045f9081527f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b939250905b80821061076757509091508101602001610713610703565b91926001816020925483858801015201910190929161074f565b60ff191660208086019190915291151560051b840190910191506107139050610703565b6001600160a01b0381160361056857565b34610568576040366003190112610568576107e06004356107d6816107a5565b60243590336131db565b602060405160018152f35b34610568575f36600319011261056857602061080561281d565b604051908152f35b34610568576020366003190112610568577f3525e22824a8a7df2c9a6029941c824cf95b6447f1e13d5128fd3826d35afe8b602060043561084d816107a5565b610855612c9b565b6001600160a01b03165f818152600c8352604090819020805460ff1916905551908152a1005b34610568575f366003190112610568576020601b54604051908152f35b34610568576020366003190112610568576004356108b4612c9b565b80601b556040519081527f916ff272633038d0abe980fe85fc806583ed82affe64f78fe9378d5e7eff851260203392a2005b34610568575f366003190112610568576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b34610568575f366003190112610568576020600354604051908152f35b34610568576020366003190112610568576004356109648161055e565b61096c612c9b565b151560ff19601c541660ff821617601c556040519081527ff6984cfef3d159bf05cd8946ea5d8764345d2d74b4043d97407e2cf45bbaf5b260203392a2005b34610568575f6040366003190112610568576004356109c9816107a5565b602435906109d5612c9b565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031691823b156105685760405163040b850f60e31b81526001600160a01b0390921660048301526024820152905f908290604490829084905af1801561068457610678575080f35b604090600319011261056857600435610a5d816107a5565b906024356106c88161055e565b3461056857610a7836610a45565b90610a81612c9b565b6001600160a01b03165f818152602160205260409020805460ff191660ff841515161790559060405190151581527fcf6988e4ab219d22e184919b0127588d212fb5379d51b3f958911e45c7b4e83a60203392a3005b606090600319011261056857600435610aef816107a5565b90602435610afc816107a5565b9060443590565b3461056857610b1136610ad7565b6001600160a01b0383165f9081526002602090815260408083203384529091529020909190549260018401610b57575b610b4b9350612cc1565b60405160018152602090f35b828410610bc0576001600160a01b0381168015610bad573315610b9a575f9081526002602090815260408083203384529091529020610b4b948490039055610b41565b634a1406b160e11b5f525f60045260245ffd5b63e602df0560e01b5f525f60045260245ffd5b8284637dc7a0d960e11b5f523360045260245260445260645ffd5b34610568575f36600319011261056857602060ff601554166040519015158152f35b3461056857602036600319011261056857600435610c1a816107a5565b610c22612c9b565b601a80546001600160a01b0319166001600160a01b03929092169182179055337f087168495b2024a05f1e51c26b5abadc7eaa5984c24a419d3563f092693ca1d55f80a3005b3461056857602036600319011261056857600435610c85816107a5565b60018060a01b03165f52601d602052602060405f2054604051908152f35b3461056857602036600319011261056857600435610cc0816107a5565b610cc8612c9b565b60018060a01b0316805f52600d60205260405f20600160ff198254161790556040519081527f19d8e56f1e137a5d300ff5835cc40cd26072c22fce3f03785530eba3c6edad8460203392a2005b34610568575f36600319011261056857602060405160128152f35b634e487b7160e01b5f52604160045260245ffd5b604081019081106001600160401b03821117610d5f57604052565b610d30565b60a081019081106001600160401b03821117610d5f57604052565b60c081019081106001600160401b03821117610d5f57604052565b90601f801991011681019081106001600160401b03821117610d5f57604052565b60405190610dca604083610d9a565b565b6001600160401b038111610d5f5760051b60200190565b9080601f83011215610568578135610dfa81610dcc565b92610e086040519485610d9a565b81845260208085019260051b82010192831161056857602001905b828210610e305750505090565b602080918335610e3f816107a5565b815201910190610e23565b34610568576040366003190112610568576004356001600160401b03811161056857610e7a903690600401610de3565b6024356001600160401b038111610568573660238201121561056857806004013591610ea583610dcc565b91610eb36040519384610d9a565b8383526024602084019460051b8201019036821161056857602401935b818510610ee157610018848461286d565b8435815260209485019401610ed0565b3461056857604036600319011261056857600435610f0e816107a5565b60243565ffffffffffff610f2143612d71565b169182821015610f74576001600160a01b03165f908152600a6020526040902061071f92506001600160d01b0391610f639190610f5d90612d71565b90612da0565b604051911681529081906020820190565b50637669fc0f60e11b5f5260045260245260445ffd5b34610568576040366003190112610568576004356001600160401b03811161056857610fba903690600401610de3565b602435610fc68161055e565b610fce612c9b565b801515905f5b8351811015610018576001906001600160a01b03610ff2828761295d565b5116805f52602080526110148460405f209060ff801983541691151516179055565b7f3375dbb7bc3f78ac8b016c767fc4f6fe71b91a517596f73013687b3c4679abda6020604051878152a201610fd4565b34610568575f3660031901126105685761105c612c9b565b60115460ff8160181c16156110a15763ff00000019166011557f5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa6020604051338152a1005b638dfc202b60e01b5f5260045ffd5b34610568575f36600319011261056857602060ff60115460101c16604051908152f35b34610568575f366003190112610568576018546040516001600160a01b039091168152602090f35b34610568575f3660031901126105685761111443612d71565b65ffffffffffff8061112543612d71565b1691160361117c5761071f60405161113e604082610d9a565b601d81527f6d6f64653d626c6f636b6e756d6265722666726f6d3d64656661756c740000006020820152604051918291602083526020830190610693565b6301bfc1c560e61b5f5260045ffd5b3461056857608036600319011261056857602061080560643560443560243560043561298c565b34610568576020366003190112610568576004356111cf816107a5565b60018060a01b03165f526009602052602060018060a01b0360405f205416604051908152f35b3461056857602036600319011261056857600435611212816107a5565b60018060a01b03165f526021602052602060ff60405f2054166040519015158152f35b3461056857602036600319011261056857610018600435611255816107a5565b33612e31565b34610568575f36600319011261056857602060ff60115460181c166040519015158152f35b34610568575f36600319011261056857602060ff601c54166040519015158152f35b34610568575f366003190112610568576020601754604051908152f35b34610568576020366003190112610568576004356112dc816107a5565b60018060a01b03165f52601e602052602060405f2054604051908152f35b3461056857602036600319011261056857600435611317816107a5565b6001600160a01b03165f908152600a602052604090205463ffffffff811161134b5760405163ffffffff9091168152602090f35b6306dfcc6560e41b5f52602060045260245260445ffd5b34610568576020366003190112610568576020610805600435611384816107a5565b6001600160a01b03165f9081526001602052604090205490565b34610568575f366003190112610568576113b6612c9b565b5f80546001600160a01b0319811682556001600160a01b03167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a3005b3461056857602036600319011261056857600435611412816107a5565b60018060a01b03165f52600c602052602060ff60405f2054166040519015158152f35b34610568575f366003190112610568576020600f54604051908152f35b346105685760203660031901126105685760043561146f816107a5565b611477612c9b565b600e54604080516001600160a01b038084168252909316602084018190529233917f8a2921926cceeec9c87402055ba6edb6a752234970f3b7b8f99183b622b3e01491a26001600160a01b03191617600e55005b34610568575f36600319011261056857600e546040516001600160a01b039091168152602090f35b3461056857602036600319011261056857600435611510816107a5565b60018060a01b03165f526008602052602060405f2054604051908152f35b34610568575f36600319011261056857602060ff60115460081c16604051908152f35b34610568575f36600319011261056857611569612c9b565b60115460ff8160181c166115b45763010000009063ff0000001916176011557f62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a2586020604051338152a1005b63d93c066560e01b5f5260045ffd5b90602080835192838152019201905f5b8181106115e05750505090565b82518452602093840193909201916001016115d3565b34610568575f366003190112610568576116986116327f0000000000000000000000000000000000000000000000000000000000000000613689565b61071f61165e7f00000000000000000000000000000000000000000000000000000000000000006136e9565b6116a660405191611670602084610d9a565b5f808452366020850137604051958695600f60f81b875260e0602088015260e0870190610693565b908582036040870152610693565b904660608501523060808501525f60a085015283820360c08501526115c3565b34610568575f366003190112610568575f546040516001600160a01b039091168152602090f35b346105685760203660031901126105685760043565ffffffffffff61171143612d71565b1690818110156117d15761172490612d71565b600b54905f829160058411611778575b6117409350600b613503565b8061175c575060205f5b6040516001600160d01b039091168152f35b6117676020916127b6565b600b5f52815f20015460301c61174a565b9192611783816133a5565b81039081116117cc5761174093600b5f5265ffffffffffff8260205f2001541665ffffffffffff8516105f146117ba575091611734565b9291506117c690612802565b90611734565b6126de565b637669fc0f60e11b5f5260045260245260445ffd5b34610568575f36600319011261056857602061180143612d71565b65ffffffffffff60405191168152f35b34610568575f366003190112610568576040515f600554611831816126fd565b808452906001811690811561078157506001146118585761071f8361071381850382610d9a565b60055f9081527f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db0939250905b80821061189c57509091508101602001610713610703565b919260018160209254838588010152019101909291611884565b34610568576020366003190112610568576004356118d3816107a5565b6001600160a01b03165f908152600a602090815260409091206001600160d01b03906118fe90612ef8565b16604051908152f35b34610568575f36600319011261056857602060ff60115416604051908152f35b3461056857602036600319011261056857600435611943612c9b565b42811061197b576020817f348d0db1c3991f269b964876f1d5cf8976d0d86d5bd168c53ca620bd0a03c2af92601255604051908152a1005b631bbc3f2560e01b5f5260045260245ffd5b34610568575f366003190112610568576020601454604051908152f35b34610568576020366003190112610568576004356119c6612c9b565b80156119fe57806014556040519081527f3010fdc1b5967863eed0d8921b2cb06100ebca4e26b41e5ae029d2f44040cc3160203392a2005b631aebcae160e21b5f5260045260245ffd5b34610568576040366003190112610568576107e0600435611a30816107a5565b6024359033612cc1565b34610568576060366003190112610568576004356003811015610568576024356001600160401b03811161056857366023820112156105685780600401356001600160401b038111610568573660248284010111610568576100189260246044359301906129b6565b34610568575f366003190112610568576020601254604051908152f35b34610568575f366003190112610568576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b34610568575f36600319011261056857601a546040516001600160a01b039091168152602090f35b34610568575f5f60031936011261056857611b45612c9b565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316803b15610568575f809160046040518094819363bb9fe6bf60e01b83525af1801561068457610678575080f35b34610568575f36600319011261056857602060ff601154821c166040519015158152f35b34610568576020366003190112610568576004355f52601f60205260a060405f20805490600181015490600281015460046003830154920154926040519485526020850152604084015260608301526080820152f35b3461056857611c2436610ad7565b91611c2d612c9b565b6001600160a01b03811680611cad5750611ca8835f8080807f9ca7c1e047552a8048d924a5a8d3c150eb861086a72a9100e5f19d1176c1b74698885af150611c73612af5565b505b604080513381526001600160a01b0394851660208201529490931692840192909252606083019190915281906080820190565b0390a1005b60405163a9059cbb60e01b81526001600160a01b0384166004820152602481018590529390602090859060449082905f905af1908115610684577f9ca7c1e047552a8048d924a5a8d3c150eb861086a72a9100e5f19d1176c1b74694611ca892611d18575b50611c75565b611d399060203d602011611d40575b611d318183610d9a565b810190612ae0565b505f611d12565b503d611d27565b34610568575f366003190112610568576020601954604051908152f35b34610568575f602036600319011261056857600435611d82816107a5565b611d8a612c9b565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031690813b156105685760405163611d2e7560e11b81526001600160a01b039091166004820152905f908290602490829084905af1801561068457610678575080f35b34610568575f366003190112610568576040516370a0823160e01b81523060048201526020816024817f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03165afa80156106845761071f915f91611e6c575b506040519081529081906020820190565b611e8e915060203d602011611e94575b611e868183610d9a565b810190612b24565b5f611e5b565b503d611e7c565b6064359060ff8216820361056857565b346105685760c036600319011261056857600435611ec8816107a5565b60443590602435611ed7611e9b565b60843560a43591854211611f7b5791611f6f91611f769360426100189860405160208101917fe48329057bfd03d55e49b547132e39cffd9c1820ad7b9d4c5307691425d15adf835260018060a01b038b166040830152896060830152608082015260808152611f4760a082610d9a565b519020611f52613720565b906040519161190160f01b83526002830152602282015220612f91565b9182612fa9565b612e31565b85632341d78760e11b5f5260045260245ffd5b3461056857602036600319011261056857600435611faa612c9b565b8015611fe257806013556040519081527f8c1b93b742f4e4dae01db73f2c90246af768e8a534012172c37070fc611c1ee060203392a2005b633430762f60e01b5f5260045260245ffd5b34610568575f366003190112610568576020601654604051908152f35b346105685760203660031901126105685760043561202e816107a5565b60018060a01b03165f5260208052602060ff60405f2054166040519015158152f35b34610568575f366003190112610568576020601354604051908152f35b5f5f600319360112610568577f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316803b15610568575f6024916040519283809263b760faf960e01b825230600483015234905af1801561068457610678575080f35b34610568576040366003190112610568576004356024356120f6612c9b565b808211801561215b575b612145576017829055601681905560408051928352602083019190915233917f8136c169a121e503b4b853d04da9ef41a1e7e48e65230c990e4af16167ad55169190a2005b90633c1a650960e01b5f5260045260245260445ffd5b506113888111612100565b90816101609103126105685790565b346105685760403660031901126105685760043560ff81168103610568576024356001600160401b038111610568576020916121b8610805923690600401612166565b90612b33565b346105685760403660031901126105685760206122146004356121e0816107a5565b602435906121ed826107a5565b60018060a01b03165f526002835260405f209060018060a01b03165f5260205260405f2090565b54604051908152f35b34610568576020366003190112610568577f47d1c22a25bb3a5d4e481b9b1e6944c2eade3181a0a20b495ed61d35b5323f24602060043561225d816107a5565b612265612c9b565b6001600160a01b03165f818152600c8352604090819020805460ff1916600117905551908152a1005b346105685761229c36610a45565b906122a5612c9b565b6001600160a01b03165f818152602260205260409020805460ff191660ff84151516179055908080612321575b612309575b604051901515815233907f82b5329e978405cfc6bb2feddf520e11fc1e1f83bd34031f3e3cd6935ecd3c5190602090a3005b815f526020805260405f2060ff1981541690556122d7565b50815f526020805260ff60405f2054166122d2565b34610568575f366003190112610568576020601054604051908152f35b346105685760403660031901126105685761071f6123b5600435612376816107a5565b61237e6105dc565b90612387612c83565b50612390612c83565b506001600160a01b03165f908152600a602052604090206123af612c83565b50613952565b50604051906123c382610d44565b5465ffffffffffff811680835260309190911c60209283019081526040805192835290516001600160d01b031692820192909252918291820190565b346105685760203660031901126105685760043561241c816107a5565b612424612c9b565b5f546001600160a01b03163015610bad578015610b9a57305f8181526002602090815260408083206001600160a01b03861684528252808320839055519182527f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92591a361248f612c9b565b6001600160a01b038116156124b157806124ab61001892612eb2565b30613250565b631e4fbdf760e01b5f525f60045260245ffd5b34610568576060366003190112610568576004356001600160401b0381116105685761250e6124fa612522923690600401612166565b60243560443591612509612f22565b6130df565b604051928392604084526040840190610693565b9060208301520390f35b346105685760a03660031901126105685760405161254981610d64565b60043581526024356020820152604435604082015260643560608201526084356080820152612576612c9b565b60208101805160408301908151908181116126495750506125a16060840192835192519051906127c4565b1061263657506080810151600354811161262357506125fc816125cd81515f52601f60205260405f2090565b906080600491805184556020810151600185015560408101516002850155606081015160038501550151910155565b51337eee22183d0e0f6598c38aa70720d17b595a6b1fc800ca09d0582ac5b75862235f80a3005b639a1806a160e01b5f5260045260245b5ffd5b516360d6756960e01b5f5260045260245ffd5b63035ec09760e41b5f5260045260245260445ffd5b346105685760203660031901126105685760043561267b816107a5565b60018060a01b03165f52600d602052602060ff60405f2054166040519015158152f35b34610568576020366003190112610568576004356126bb816107a5565b60018060a01b03165f526022602052602060ff60405f2054166040519015158152f35b634e487b7160e01b5f52601160045260245ffd5b6040513d5f823e3d90fd5b90600182811c9216801561272b575b602083101461271757565b634e487b7160e01b5f52602260045260245ffd5b91607f169161270c565b5f9291815491612744836126fd565b8083529260018116908115612799575060011461276057505050565b5f9081526020812093945091925b83831061277f575060209250010190565b60018160209294939454838587010152019101919061276e565b915050602093945060ff929192191683830152151560051b010190565b5f198101919082116117cc57565b919082039182116117cc57565b81156127db570490565b634e487b7160e01b5f52601260045260245ffd5b818102929181159184041417156117cc57565b90600182018092116117cc57565b919082018092116117cc57565b60125442034281116117cc5761283961284291601454906127d1565b601354906127ef565b60175490818101908181116117cc5760165491821161286057505090565b8103915081116117cc5790565b90612876612c9b565b8151815103612906575f5b82518110156128cd57806128976001928461295d565b516128c6838060a01b036128ab848861295d565b51166001600160a01b03165f908152601d6020526040902090565b5501612881565b506129017f4df7ce3c8b6620256dc05b7c149884035d5e99acc5efda5253178b85cb70cae791604051918291339583612d4c565b0390a2565b60405163a2b9173160e01b81529182916129239160048401612d4c565b0390fd5b634e487b7160e01b5f52603260045260245ffd5b8051156129485760200190565b612927565b8051600110156129485760400190565b80518210156129485760209160051b010190565b6001600160401b038111610d5f57601f01601f191660200190565b91612996916127ef565b81018091116117cc57670de0b6b3a7640000916129b2916127ef565b0490565b5091908260c0916129c5612f22565b8101031261056857604051916129da83610d7f565b80356129e5816107a5565b80845260208201358060208601526040830135926001600160801b0384168403610568577f99b7f459b788f97ae979130adbffc6d4ba2454cad7595ce30981a8487319f4f1946001600160801b0360a092612a7e612a71612a90978960408d015260608401359b8c6060820152876080860135958660808401520135978891015260018060a01b031690565b976001600160801b031690565b93818103612abf5750925b169061298c565b90612a9c823083612cc1565b604080516001600160a01b03909216825260208201929092529081908101612901565b90612ace612ada924890612810565b90818082109118021890565b92612a89565b9081602091031261056857516106c88161055e565b3d15612b1f573d90612b0682612971565b91612b146040519384610d9a565b82523d5f602084013e565b606090565b90816020910312610568575190565b906011549160ff808460081c169116145f14612c7d57612c4e612b5582612fe9565b92612c4060208401359160808501359460a08101359160c082013560e083013561010084013591612be1612b92612b99612b926060890189612ff3565b3691613025565b602081519101209560ff612bdb612bcc612bb9612b9260408d018d612ff3565b602081519101209a610120810190612ff3565b92909360101c16601054612810565b9161305b565b60208151910120956040519a8b9960208b019d8e9693909a9998959261012098959261014089019c60018060a01b03168952602089015260408801526060870152608086015260a085015260c084015260e08301526101008201520152565b03601f198101835282610d9a565b51902060408051602081019283524691810191909152306060820152612c778160808101612c40565b51902090565b50505f90565b60405190612c9082610d44565b5f6020838281520152565b5f546001600160a01b03163303612cae57565b63118cdaa760e01b5f523360045260245ffd5b91906001600160a01b03831615612cfd576001600160a01b03811615612cea57610dca926132c4565b63ec442f0560e01b5f525f60045260245ffd5b634b637e8f60e11b5f525f60045260245ffd5b90602080835192838152019201905f5b818110612d2d5750505090565b82516001600160a01b0316845260209384019390920191600101612d20565b9091612d636106c893604084526040840190612d10565b9160208184039101526115c3565b65ffffffffffff8111612d895765ffffffffffff1690565b6306dfcc6560e41b5f52603060045260245260445ffd5b908154905f829160058411612dde575b612dbb935084613503565b80612dc65750505f90565b612dcf906127b6565b905f5260205f20015460301c90565b9192612de9816133a5565b81039081116117cc57612dbb93855f5265ffffffffffff8260205f2001541665ffffffffffff8516105f14612e1f575091612db0565b929150612e2b90612802565b90612db0565b6001600160a01b038181165f81815260096020526040812080548685166001600160a01b031982168117909255610dca96941694612eac9390928691907f3134e8a2e6d97e929a7e54011ea5485d7d196dd5f0ba4d4ef95803e8e3fc257f9080a46001600160a01b03165f9081526001602052604090205490565b91613567565b5f80546001600160a01b039283166001600160a01b03198216811783559216907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09080a3565b80549081612f065750505f90565b815f198101116117cc575f525f199060205f2001015460301c90565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03163303612f5457565b60405162461bcd60e51b815260206004820152601560248201527414d95b99195c881b9bdd08115b9d1c9e541bda5b9d605a1b6044820152606490fd5b916106c89391612fa093613836565b909291926138d6565b6001600160a01b03165f81815260086020526040902080546001810190915591829003612fd4575050565b6301d4b62360e61b5f5260045260245260445ffd5b356106c8816107a5565b903590601e198136030182121561056857018035906001600160401b0382116105685760200191813603831361056857565b92919261303182612971565b9161303f6040519384610d9a565b829481845281830111610568578281602093845f960137010152565b909291928311610568579190565b906006116105685790600690565b90600c116105685760060190600690565b90601c1161056857600c0190601090565b90603c1161056857601c0190602090565b9092919283603c1161056857831161056857603c0191603b190190565b90939293848311610568578411610568578101920390565b92916130ef610120850185612ff3565b60109591955490818111156131c657600182018083116117cc57816131198261313c95838c6130c7565b6001600160f81b0319913591821691600182106131a6575b505060f81c986130c7565b9060115461315361314d8260ff1690565b60ff1690565b880361316b57505050613167939450613b67565b9091565b919350919061317f9060081c60ff1661314d565b8603613190576131679495506139ef565b63c7b3aa1760e01b5f5260ff861660045260245ffd5b6001600160f81b031960019290920360031b82901b161690505f80613131565b635befaf5d60e01b5f5260045260245260445ffd5b6001600160a01b0316908115610bad576001600160a01b038116928315610b9a57806132437f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92593855f52600260205260405f209060018060a01b03165f5260205260405f2090565b55604051908152602090a3565b6001600160a01b03168015610bad576001600160a01b038216918215610b9a575f8281526002602090815260408083206001600160a01b039094168352929052205f1990556040515f1981527f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92590602090a3565b90821561339a576001600160a01b0382165f90815260208052604090205460ff16801561337a575b801561336b575b61336157613323610dca936133088385613e49565b60115460201c60ff1680613338575b613329575b828461403d565b91613d14565b6133338184613f0a565b61331c565b506001600160a01b0384165f90815260216020526040902061335c905b5460ff1690565b613317565b610dca9291613d14565b5060ff601c5460081c166132f3565b506001600160a01b0381165f90815260208052604090205460ff166132ec565b90610dca9250613c3d565b60018111156106c857806001600160801b8210156134c6575b61346c61346261345861344e61344461343a6134296134739760048a600160401b6134789c10156134b9575b6401000000008110156134ac575b6201000081101561349f575b610100811015613492575b6010811015613485575b101561347d575b60030260011c90565b613433818b6127d1565b0160011c90565b613433818a6127d1565b61343381896127d1565b61343381886127d1565b61343381876127d1565b61343381866127d1565b80936127d1565b821190565b900390565b60011b613420565b60041c9160021b91613419565b60081c9160041b9161340f565b60101c9160081b91613404565b60201c9160101b916133f8565b60401c9160201b916133ea565b505061347861347361346c61346261345861344e61344461343a6134296134ed8a60801c90565b9850600160401b97506133be9650505050505050565b91905b8382106135135750505090565b9091928083169080841860011c82018092116117cc57845f5265ffffffffffff8260205f2001541665ffffffffffff8416105f146135555750925b9190613506565b93925061356190612802565b9161354e565b6001600160a01b03808316939291908116908185141580613680575b61358f575b5050505050565b81613613575b5050826135a4575b8080613588565b6001600160a01b03165f908152600a602052604090207fdec2bacdd2f05b59de34da9b523dff8be42e5e38e818c82fdb0bae774387a724916135f0916135ea909161410f565b90614174565b604080516001600160d01b039384168152919092166020820152a25f808061359d565b6001600160a01b03165f908152600a602052604090207fdec2bacdd2f05b59de34da9b523dff8be42e5e38e818c82fdb0bae774387a7249061365e906136588661410f565b90614140565b604080516001600160d01b039384168152919092166020820152a25f80613595565b50831515613583565b60ff81146136cf5760ff811690601f82116136c057604051916136ad604084610d9a565b6020808452838101919036833783525290565b632cd44ac360e21b5f5260045ffd5b506040516106c8816136e2816006612735565b0382610d9a565b60ff811461370d5760ff811690601f82116136c057604051916136ad604084610d9a565b506040516106c8816136e2816007612735565b307f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316148061380d575b1561377b577f000000000000000000000000000000000000000000000000000000000000000090565b60405160208101907f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f82527f000000000000000000000000000000000000000000000000000000000000000060408201527f000000000000000000000000000000000000000000000000000000000000000060608201524660808201523060a082015260a08152612c7760c082610d9a565b507f00000000000000000000000000000000000000000000000000000000000000004614613752565b91907f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a084116138ad579160209360809260ff5f9560405194855216868401526040830152606082015282805260015afa15610684575f516001600160a01b038116156138a357905f905f90565b505f906001905f90565b5050505f9160039190565b600411156138c257565b634e487b7160e01b5f52602160045260245ffd5b6138df816138b8565b806138e8575050565b6138f1816138b8565b600181036139085763f645eedf60e01b5f5260045ffd5b613911816138b8565b6002810361392c575063fce698f760e01b5f5260045260245ffd5b806139386003926138b8565b146139405750565b6335e2f38360e21b5f5260045260245ffd5b8054821015612948575f5260205f2001905f90565b356001600160d01b0319811692919060068210613982575050565b6001600160d01b031960069290920360031b82901b16169150565b356001600160801b03198116929190601082106139b8575050565b6001600160801b031960109290920360031b82901b16169150565b3590602081106139e1575090565b5f199060200360031b1b1690565b9392909160115492613a0861314d8560ff9060101c1690565b8210613b5357613a2a613a24613a1e8484613069565b90613967565b60d01c90565b93613a3b613a24613a1e8585613077565b613a75613a5a613a54613a4e8787613088565b9061399d565b60801c90565b9480613a6f613a698288613099565b906139d3565b956130aa565b96908415613b3f57604088141580613b34575b613b2557613b12613355613af9613b219a613af3613b16958f613abe613aeb91613ab9613b1b9d60ff9060081c1690565b612b33565b7f19457468657265756d205369676e6564204d6573736167653a0a3332000000005f52601c52603c5f2090565b923691613025565b906141dd565b6001600160a01b03165f908152600c6020526040902090565b1590565b6141ea565b956142bd565b9190565b636cb078bd60e01b5f5260045ffd5b506041881415613a88565b63279b844d60e21b5f52600485905260245ffd5b63a5a8009960e01b5f52600482905260245ffd5b600e5490939291906001600160a01b03168015613c225750613b88906143b1565b60a0840135600f54811115613c105750613ba56040850185612ff3565b9050613c02575b80613bb961138486612fe9565b10613bd75750613bd29192613bcc614353565b90614227565b905f90565b61263390613be485612fe9565b6365d462ff60e01b5f526001600160a01b0316600452602452604490565b613c0b846143ef565b613bac565b630662500360e01b5f5260045260245ffd5b632279d43d60e01b5f526001600160a01b031660045260245ffd5b91905f906001600160a01b0384168015908115613cfa57613c68613c6385600354612810565b600355565b6001600160a01b0383169081613ce4575b6040518581527fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef90602090a3613cb4575b610dca9293614440565b6003546001600160d01b0390818111613cce575050613caa565b630e58ae9360e11b845260045260245250604490fd5b6001600160a01b0384165f526001602052613c79565b6001600160a01b0386165f90815260016020529350613c68565b9291906001600160a01b0384168015908115613de457613d39613c6385600354612810565b6001600160a01b0383169081613dc257613d568560035403600355565b6040518581527fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef90602090a3613d9057610dca9293614440565b600354936001600160d01b03808611613dab57509350613caa565b630e58ae9360e11b5f52600486905260245260445ffd5b6001600160a01b0384165f908152600160205260409020858154019055613d56565b6001600160a01b0386165f90815260016020526040902054848110613e25576001600160a01b0387165f908152600160205260409020908590039055613d39565b63391434e360e21b5f526001600160a01b038716600452602452604484905260645ffd5b60ff60115460181c168015613ead575b8015613e8c575b613e68575050565b6389ca956560e01b5f9081526001600160a01b039182166004529116602452604490fd5b506001600160a01b0382165f9081526022602052604090205460ff16613e60565b506001600160a01b0381165f9081526022602052604090205460ff16613e59565b90604051613edb81610d64565b608060048294805484526001810154602085015260028101546040850152600381015460608501520154910152565b6001600160a01b0381165f908152601d6020526040902090919054801561401e57613f45613f40825f52601f60205260405f2090565b613ece565b90613f52613b12836144f5565b613fff575060608101613f69613b12825186614514565b613fb5575060800151809111613f9557506001600160a01b03165f908152601e60205260409020429055565b6339f1ab3360e11b5f526001600160a01b0390911660045260245260445ffd5b83613fe061263392613fd78360018060a01b03165f52601e60205260405f2090565b54905190612810565b62f3369760e71b5f526001600160a01b03909116600452602452604490565b631d2e5cc360e21b5f526001600160a01b03841660045260245260445ffd5b6373509bdf60e01b5f526001600160a01b03831660045260245260445ffd5b9082601754156141095761407091601954601b541115806140fd575b806140e5575b806140d5575b6140a4575b836146fd565b908161407b57505090565b9161409f826106c89461409861409383601954612810565b601955565b3090613d14565b6127c4565b6140b861010061ff0019601c541617601c55565b6140c0614558565b6140d061ff0019601c5416601c55565b61406a565b5060ff601c5460081c1615614065565b506018546001600160a01b038581169116141561405f565b5060ff601c5416614059565b50505090565b6001600160d01b038111614129576001600160d01b031690565b6306dfcc6560e41b5f5260d060045260245260445ffd5b9061414a43612d71565b9061415483612ef8565b6001600160d01b0391821690821603919082116117cc57613167926149ac565b9061417e43612d71565b9061418883612ef8565b6001600160d01b0391821690821601919082116117cc57613167926149ac565b6141b143612d71565b906141bc600b612ef8565b6001600160d01b03918216908216039081116117cc5761316791600b6149ac565b6106c891612fa0916147ad565b9091901561421e5760ff6001915b65ffffffffffff60d01b9060d01b169265ffffffffffff60a01b9060a01b169116171790565b60ff5f916141f8565b919091803591614236836107a5565b6001600160801b0361010060e0840135930135936040519061425782610d7f565b60018060a01b0316958682526020820190815260a060408301925f8452606081019586526080810196875201958652604051966020880152516040870152511660608501525160808401525160a08301525160c082015260c081526106c860e082610d9a565b9091926001600160801b038235946142d4866107a5565b61010060e08501359401359460a0604051976142ef89610d7f565b600180831b03169788815260208101928352846040820194168452606081019586526080810196875201958652604051966020880152516040870152511660608501525160808401525160a08301525160c082015260c081526106c860e082610d9a565b600e5460405163d1eca9cf60e01b8152670de0b6b3a7640000600482015290602090829060249082906001600160a01b03165afa908115610684575f91614398575090565b6106c8915060203d602011611e9457611e868183610d9a565b600e5460405163d1eca9cf60e01b81526004810192909252602090829060249082906001600160a01b03165afa908115610684575f91614398575090565b6143fd906040810190612ff3565b601411610568573560601c805f52600d60205260ff60405f205416156144205750565b6311eb6fa160e11b5f9081526001600160a01b0391909116600452602490fd5b9091906001600160a01b031680156144a7575b610dca926001600160a01b031690811561448f575b5f90815260096020526040808220549282529020546001600160a01b039081169116613567565b6144a061449b8461410f565b6141a8565b5050614468565b6144b08261410f565b926144ba43612d71565b936144c5600b612ef8565b6001600160d01b0391821690821601949085116117cc57610dca946144eb91600b6149ac565b9050509250614453565b60208101514210159081614507575090565b9050604042910151101590565b6001600160a01b03165f818152601e6020526040902054159190821561453957505090565b9091505f52601e60205260405f20549081018091116117cc5742101590565b601b5480156146fa578060011c908181039081116117cc57476145796147e7565b91614596306145878561293b565b6001600160a01b039091169052565b6040516315ab88c960e31b81527f00000000000000000000000000000000000000000000000000000000000000006001600160a01b038116949190602082600481895afa908115610684576145fb8592614610945f916146cb575b506145878661294d565b61460a614093836019546127c4565b306131db565b833b156105685761463e935f928360405180978195829463791ac94760e01b8452429130916004860161481e565b03925af191821561068457614659926146b1575b50476127c4565b811515806146a8575b61466a575050565b81614696827ff57bc8a758e34a73fa02c39d5c4c83f6025dbf3df95899ecc7c023cf4212762294614872565b604080519182526020820192909252a1565b50801515614662565b806146bf5f6146c593610d9a565b80610689565b5f614652565b6146ed915060203d6020116146f3575b6146e58183610d9a565b810190614809565b5f6145f1565b503d6146db565b50565b6001600160a01b03165f90815260208052604090205460ff16801561478d575b801561477e575b612c7d576001600160a01b03165f90815260216020526040902061474790613355565b80614773575b61475657505f90565b61476b6106c89161476561281d565b906127ef565b612710900490565b50601754151561474d565b50601c5460081c60ff16614724565b506001600160a01b0381165f90815260208052604090205460ff1661471d565b81519190604183036147dd576147d69250602082015190606060408401519301515f1a90613836565b9192909190565b50505f9160029190565b604051606091906147f88382610d9a565b6002815291601f1901366020840137565b9081602091031261056857516106c8816107a5565b90608092614843919695949683525f602084015260a0604084015260a0830190612d10565b6001600160a01b0390951660608201520152565b90816060910312610568578051916040602083015192015190565b601954908082039182116117cc5761490a9261488f606093601955565b7f0000000000000000000000000000000000000000000000000000000000000000906148bc8383306131db565b601a5460405163f305d71960e01b815230600482015260248101949094525f6044850181905260648501526001600160a01b031660848401524260a4840152919384928391829060c4820190565b03926001600160a01b03165af18015610684576149245750565b6149459060603d60601161494a575b61493d8183610d9a565b810190614857565b505050565b503d614933565b8054600160401b811015610d5f5761496e91600182018155613952565b61499957815160209092015160301b65ffffffffffff191665ffffffffffff92909216919091179055565b634e487b7160e01b5f525f60045260245ffd5b80549293928015614a54576149c36149ce916127b6565b825f5260205f200190565b8054603081901c9365ffffffffffff91821692918116808411614a4557879303614a115750613b2192509065ffffffffffff82549181199060301b169116179055565b915050613b2191614a31614a23610dbb565b65ffffffffffff9093168352565b6001600160d01b0386166020830152614951565b632520601d60e01b5f5260045ffd5b5090614a7991614a65614a23610dbb565b6001600160d01b0385166020830152614951565b5f919056fea26469706673582212207274cc1f47b68830cfebeeb5594e49314cf3961addd9bc4aade605c28b0aaad364736f6c634300081c0033ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef0175b7a638427703f0dbe7bb9bbf987a2551717b34e79f33b5b1008d1fa01db88c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925dec2bacdd2f05b59de34da9b523dff8be42e5e38e818c82fdb0bae774387a7240000000000000000000000005ff137d4b0fdcd49dca30c7cf57e578a026d2789000000000000000000000000b99f671b24b8e1da7a67efbdb0b627bef9068c6500000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000"));
        let gpu_device_string = args.next().unwrap_or_else(|| String::from("255"));
        let leading_zeroes_threshold_string = args.next().unwrap_or_else(|| String::from("0"));
        let total_zeroes_threshold_string = args.next().unwrap_or_else(|| String::from("0"));

        // convert main arguments from hex string to vector of bytes
        let Ok(factory_address_vec) = hex::decode(factory_address_string) else {
            return Err("could not decode factory address argument");
        };
        let Ok(calling_address_vec) = hex::decode(calling_address_string) else {
            return Err("could not decode calling address argument");
        };
        let Ok(init_code_hash_vec) = hex::decode(init_code_hash_string) else {
            return Err("could not decode initialization code hash argument");
        };

        // convert from vector to fixed array
        let Ok(factory_address) = factory_address_vec.try_into() else {
            return Err("invalid length for factory address argument");
        };
        let Ok(calling_address) = calling_address_vec.try_into() else {
            return Err("invalid length for calling address argument");
        };
        let Ok(init_code_hash) =  keccak256(init_code_hash_vec).try_into() else {
            return Err("invalid length for initialization code hash argument");
        };


        // convert gpu arguments to u8 values
        let Ok(gpu_device) = gpu_device_string.parse::<u8>() else {
            return Err("invalid gpu device value");
        };
        let Ok(leading_zeroes_threshold) = leading_zeroes_threshold_string.parse::<u8>() else {
            return Err("invalid leading zeroes threshold value supplied");
        };
        let Ok(total_zeroes_threshold) = total_zeroes_threshold_string.parse::<u8>() else {
            return Err("invalid total zeroes threshold value supplied");
        };

        if leading_zeroes_threshold > 20 {
            return Err("invalid value for leading zeroes threshold argument. (valid: 0..=20)");
        }
        if total_zeroes_threshold > 20 && total_zeroes_threshold != 255 {
            return Err("invalid value for total zeroes threshold argument. (valid: 0..=20 | 255)");
        }

        Ok(Self {
            factory_address,
            calling_address,
            init_code_hash,
            gpu_device,
            leading_zeroes_threshold,
            total_zeroes_threshold,
        })
    }
}

/// Given a Config object with a factory address, a caller address, and a
/// keccak-256 hash of the contract initialization code, search for salts that
/// will enable the factory contract to deploy a contract to a gas-efficient
/// address via CREATE2.
///
/// The 32-byte salt is constructed as follows:
///   - the 20-byte calling address (to prevent frontrunning)
///   - a random 6-byte segment (to prevent collisions with other runs)
///   - a 6-byte nonce segment (incrementally stepped through during the run)
///
/// When a salt that will result in the creation of a gas-efficient contract
/// address is found, it will be appended to `efficient_addresses.txt` along
/// with the resultant address and the "value" (i.e. approximate rarity) of the
/// resultant address.
pub fn cpu(config: Config) -> Result<(), Box<dyn Error>> {
    // (create if necessary) and open a file where found salts will be written
    let file = output_file();

    // create object for computing rewards (relative rarity) for a given address
    let rewards = Reward::new();

    // begin searching for addresses
    loop {
        // header: 0xff ++ factory ++ caller ++ salt_random_segment (47 bytes)
        let mut header = [0; 47];
        header[0] = CONTROL_CHARACTER;
        header[1..21].copy_from_slice(&config.factory_address);
        header[21..41].copy_from_slice(&config.calling_address);
        header[41..].copy_from_slice(&FixedBytes::<6>::random()[..]);

        // create new hash object
        let mut hash_header = Keccak::v256();

        // update hash with header
        hash_header.update(&header);

        // iterate over a 6-byte nonce and compute each address
        (0..MAX_INCREMENTER)
            .into_par_iter() // parallelization
            .for_each(|salt| {
                let salt = salt.to_le_bytes();
                let salt_incremented_segment = &salt[..6];

                // clone the partially-hashed object
                let mut hash = hash_header.clone();

                // update with body and footer (total: 38 bytes)
                hash.update(salt_incremented_segment);
                hash.update(&config.init_code_hash);

                // hash the payload and get the result
                let mut res: [u8; 32] = [0; 32];
                hash.finalize(&mut res);

                // get the address that results from the hash
                let address = <&Address>::try_from(&res[12..]).unwrap();
                // get the full salt used to create the address
                let header_hex_string = hex::encode(header);
                let body_hex_string = hex::encode(salt_incremented_segment);
                let full_salt = format!("0x{}{}", &header_hex_string[42..], &body_hex_string);
                let add = format!("{}", address);
                // display the salt and the address.
                if add.starts_with("0xb139") {
                    let output = format!(
                        "{full_salt} => {address}",
                    );
                    println!("{output}");

                    // create a lock on the file before writing
                    file.lock_exclusive().expect("Couldn't lock file.");

                    // write the result to file
                    writeln!(&file, "{output}")
                        .expect("Couldn't write to `efficient_addresses.txt` file.");

                    // release the file lock
                    file.unlock().expect("Couldn't unlock file.")
                }

            });
    }
}

/// Given a Config object with a factory address, a caller address, a keccak-256
/// hash of the contract initialization code, and a device ID, search for salts
/// using OpenCL that will enable the factory contract to deploy a contract to a
/// gas-efficient address via CREATE2. This method also takes threshold values
/// for both leading zero bytes and total zero bytes - any address that does not
/// meet or exceed the threshold will not be returned. Default threshold values
/// are three leading zeroes or five total zeroes.
///
/// The 32-byte salt is constructed as follows:
///   - the 20-byte calling address (to prevent frontrunning)
///   - a random 4-byte segment (to prevent collisions with other runs)
///   - a 4-byte segment unique to each work group running in parallel
///   - a 4-byte nonce segment (incrementally stepped through during the run)
///
/// When a salt that will result in the creation of a gas-efficient contract
/// address is found, it will be appended to `efficient_addresses.txt` along
/// with the resultant address and the "value" (i.e. approximate rarity) of the
/// resultant address.
///
/// This method is still highly experimental and could almost certainly use
/// further optimization - contributions are more than welcome!
pub fn gpu(config: Config) -> ocl::Result<()> {
    println!(
        "Setting up experimental OpenCL miner using device {}...",
        config.gpu_device
    );

    // (create if necessary) and open a file where found salts will be written
    let file = output_file();

    // create object for computing rewards (relative rarity) for a given address
    let rewards = Reward::new();

    // track how many addresses have been found and information about them
    let mut found: u64 = 0;
    let mut found_list: Vec<String> = vec![];

    // set up a controller for terminal output
    let term = Term::stdout();

    // set up a platform to use
    let platform = Platform::new(ocl::core::default_platform()?);

    // set up the device to use
    let device = Device::by_idx_wrap(platform, config.gpu_device as usize)?;

    // set up the context to use
    let context = Context::builder()
        .platform(platform)
        .devices(device)
        .build()?;

    // set up the program to use
    let program = Program::builder()
        .devices(device)
        .src(mk_kernel_src(&config))
        .build(&context)?;

    // set up the queue to use
    let queue = Queue::new(&context, device, None)?;

    // set up the "proqueue" (or amalgamation of various elements) to use
    let ocl_pq = ProQue::new(context, queue, program, Some(WORK_SIZE));

    // create a random number generator
    let mut rng = thread_rng();

    // determine the start time
    let start_time: f64 = SystemTime::now()
        .duration_since(UNIX_EPOCH)
        .unwrap()
        .as_secs_f64();

    // set up variables for tracking performance
    let mut rate: f64 = 0.0;
    let mut cumulative_nonce: u64 = 0;

    // the previous timestamp of printing to the terminal
    let mut previous_time: f64 = 0.0;

    // the last work duration in milliseconds
    let mut work_duration_millis: u64 = 0;

    // begin searching for addresses
    loop {
        // construct the 4-byte message to hash, leaving last 8 of salt empty
        let salt = FixedBytes::<4>::random();

        // build a corresponding buffer for passing the message to the kernel
        let message_buffer = Buffer::builder()
            .queue(ocl_pq.queue().clone())
            .flags(MemFlags::new().read_only())
            .len(4)
            .copy_host_slice(&salt[..])
            .build()?;

        // reset nonce & create a buffer to view it in little-endian
        // for more uniformly distributed nonces, we shall initialize it to a random value
        let mut nonce: [u32; 1] = rng.gen();
        let mut view_buf = [0; 8];

        // build a corresponding buffer for passing the nonce to the kernel
        let mut nonce_buffer = Buffer::builder()
            .queue(ocl_pq.queue().clone())
            .flags(MemFlags::new().read_only())
            .len(1)
            .copy_host_slice(&nonce)
            .build()?;

        // establish a buffer for nonces that result in desired addresses
        let mut solutions: Vec<u64> = vec![0; 1];
        let solutions_buffer = Buffer::builder()
            .queue(ocl_pq.queue().clone())
            .flags(MemFlags::new().write_only())
            .len(1)
            .copy_host_slice(&solutions)
            .build()?;

        // repeatedly enqueue kernel to search for new addresses
        loop {
            // build the kernel and define the type of each buffer
            let kern = ocl_pq
                .kernel_builder("hashMessage")
                .arg_named("message", None::<&Buffer<u8>>)
                .arg_named("nonce", None::<&Buffer<u32>>)
                .arg_named("solutions", None::<&Buffer<u64>>)
                .build()?;

            // set each buffer
            kern.set_arg("message", Some(&message_buffer))?;
            kern.set_arg("nonce", Some(&nonce_buffer))?;
            kern.set_arg("solutions", &solutions_buffer)?;

            // enqueue the kernel
            unsafe { kern.enq()? };

            // calculate the current time
            let mut now = SystemTime::now().duration_since(UNIX_EPOCH).unwrap();
            let current_time = now.as_secs() as f64;

            // we don't want to print too fast
            let print_output = current_time - previous_time > 0.99;
            previous_time = current_time;

            // clear the terminal screen
            if print_output {
                term.clear_screen()?;

                // get the total runtime and parse into hours : minutes : seconds
                let total_runtime = current_time - start_time;
                let total_runtime_hrs = total_runtime as u64 / 3600;
                let total_runtime_mins = (total_runtime as u64 - total_runtime_hrs * 3600) / 60;
                let total_runtime_secs = total_runtime
                    - (total_runtime_hrs * 3600) as f64
                    - (total_runtime_mins * 60) as f64;

                // determine the number of attempts being made per second
                let work_rate: u128 = WORK_FACTOR * cumulative_nonce as u128;
                if total_runtime > 0.0 {
                    rate = 1.0 / total_runtime;
                }

                // fill the buffer for viewing the properly-formatted nonce
                LittleEndian::write_u64(&mut view_buf, (nonce[0] as u64) << 32);

                // calculate the terminal height, defaulting to a height of ten rows
                let height = terminal_size().map(|(_w, Height(h))| h).unwrap_or(10);

                // display information about the total runtime and work size
                term.write_line(&format!(
                    "total runtime: {}:{:02}:{:02} ({} cycles)\t\t\t\
                     work size per cycle: {}",
                    total_runtime_hrs,
                    total_runtime_mins,
                    total_runtime_secs,
                    cumulative_nonce,
                    WORK_SIZE.separated_string(),
                ))?;

                // display information about the attempt rate and found solutions
                term.write_line(&format!(
                    "rate: {:.2} million attempts per second\t\t\t\
                     total found this run: {}",
                    work_rate as f64 * rate,
                    found
                ))?;

                // display information about the current search criteria
                term.write_line(&format!(
                    "current search space: {}xxxxxxxx{:08x}\t\t\
                     threshold: {} leading or {} total zeroes",
                    hex::encode(salt),
                    BigEndian::read_u64(&view_buf),
                    config.leading_zeroes_threshold,
                    config.total_zeroes_threshold
                ))?;

                // display recently found solutions based on terminal height
                let rows = if height < 5 { 1 } else { height as usize - 4 };
                let last_rows: Vec<String> = found_list.iter().cloned().rev().take(rows).collect();
                let ordered: Vec<String> = last_rows.iter().cloned().rev().collect();
                let recently_found = &ordered.join("\n");
                term.write_line(recently_found)?;
            }

            // increment the cumulative nonce (does not reset after a match)
            cumulative_nonce += 1;

            // record the start time of the work
            let work_start_time_millis = now.as_secs() * 1000 + now.subsec_nanos() as u64 / 1000000;

            // sleep for 98% of the previous work duration to conserve CPU
            if work_duration_millis != 0 {
                std::thread::sleep(std::time::Duration::from_millis(
                    work_duration_millis * 980 / 1000,
                ));
            }

            // read the solutions from the device
            solutions_buffer.read(&mut solutions).enq()?;

            // record the end time of the work and compute how long the work took
            now = SystemTime::now().duration_since(UNIX_EPOCH).unwrap();
            work_duration_millis = (now.as_secs() * 1000 + now.subsec_nanos() as u64 / 1000000)
                - work_start_time_millis;

            // if at least one solution is found, end the loop
            if solutions[0] != 0 {
                break;
            }

            // if no solution has yet been found, increment the nonce
            nonce[0] += 1;

            // update the nonce buffer with the incremented nonce value
            nonce_buffer = Buffer::builder()
                .queue(ocl_pq.queue().clone())
                .flags(MemFlags::new().read_write())
                .len(1)
                .copy_host_slice(&nonce)
                .build()?;
        }

        // iterate over each solution, first converting to a fixed array
        for &solution in &solutions {
            if solution == 0 {
                continue;
            }

            let solution = solution.to_le_bytes();

            let mut solution_message = [0; 85];
            solution_message[0] = CONTROL_CHARACTER;
            solution_message[1..21].copy_from_slice(&config.factory_address);
            solution_message[21..41].copy_from_slice(&config.calling_address);
            solution_message[41..45].copy_from_slice(&salt[..]);
            solution_message[45..53].copy_from_slice(&solution);
            solution_message[53..].copy_from_slice(&config.init_code_hash);

            // create new hash object
            let mut hash = Keccak::v256();

            // update with header
            hash.update(&solution_message);

            // hash the payload and get the result
            let mut res: [u8; 32] = [0; 32];
            hash.finalize(&mut res);

            // get the address that results from the hash
            let address = <&Address>::try_from(&res[12..]).unwrap();
            let add = format!("{}", address);
            if add.to_lowercase().starts_with("0xb139")  {
                let output = format!(
                    "0x{}{}{} => {} ",
                    hex::encode(config.calling_address),
                    hex::encode(salt),
                    hex::encode(solution),
                    address,
                );
                println!("{}", output);
                found += 1;
            }

        }
    }
}

#[track_caller]
fn output_file() -> File {
    OpenOptions::new()
        .append(true)
        .create(true)
        .read(true)
        .open("efficient_addresses.txt")
        .expect("Could not create or open `efficient_addresses.txt` file.")
}

/// Creates the OpenCL kernel source code by populating the template with the
/// values from the Config object.
fn mk_kernel_src(config: &Config) -> String {
    let mut src = String::with_capacity(2048 + KERNEL_SRC.len());

    let factory = config.factory_address.iter();
    let caller = config.calling_address.iter();
    let hash = config.init_code_hash.iter();
    let hash = hash.enumerate().map(|(i, x)| (i + 52, x));
    for (i, x) in factory.chain(caller).enumerate().chain(hash) {
        writeln!(src, "#define S_{} {}u", i + 1, x).unwrap();
    }
    let lz = config.leading_zeroes_threshold;
    writeln!(src, "#define LEADING_ZEROES {lz}").unwrap();
    let tz = config.total_zeroes_threshold;
    writeln!(src, "#define TOTAL_ZEROES {tz}").unwrap();

    src.push_str(KERNEL_SRC);

    src
}
